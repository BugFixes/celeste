AWSTemplateFormatVersion: 2010-09-09
Description: Celeste Service

Parameters:
  ServiceName:
    Type: String
    Default: celeste
  Environment:
    Type: String
    Default: local
  DatabaseBugs:
    Type: String
    Default: bugs
  DatabaseAccounts:
    Type: String
    Default: accounts
  DatabaseAgents:
    Type: String
    Default: agents
  DatabaseComms:
    Type: String
    Default: comms
  QueueName:
    Type: String
    Default: bugs
  BuildBucket:
    Type: String
    Default: celeste
  BuildKey:
    Type: String
    Default: celeste-local.zip

Resources:
  ServiceARN:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        !Join
        - '-'
        - - !Ref ServiceName
          - 'role'
          - !Ref Environment
      AssumeRolePolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Principle:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
      Policies:
        - PolicyName: celesteLambda
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                Resource:
                  !Join
                  - ':'
                  - - 'arn'
                    - 'aws'
                    - 'sqs'
                    - !Ref AWS::Region
                    - !Ref AWS::AccountId
                    - !Ref QueueMain
              - Effect: Allow
                Action:
                  - sqs:ReveiveMessage
                Resource:
                  !Join
                  - ':'
                  - - 'arn'
                    - 'aws'
                    - 'sqs'
                    - !Ref AWS::Region
                    - !Ref AWS::AccountId
                    - !Ref QueueDeadLetter
              - Effect: Allow
                Action:
                  - dynamodb:UpdateTable
                  - dynamodb:DescribeTable
                Resource:
                  !Join
                  - ':'
                  - - 'arn'
                    - 'aws'
                    - 'dynamodb'
                    - !Ref AWS::Region
                    - !Ref AWS::AccountId
                    - !Ref DatabaseBugs
              - Effect: Allow
                Action:
                  - dynamodb:UpdateTable
                  - dynamodb:DescribeTable
                Resource:
                  !Join
                  - ':'
                  - - 'arn'
                    - 'aws'
                    - 'dynamodb'
                    - !Ref AWS::Region
                    - !Ref AWS::AccountId
                    - !Ref DatabaseAccounts
              - Effect: Allow
                Action:
                  - dynamodb:UpdateTable
                  - dynamodb:DescribeTable
                Resource:
                  !Join
                  - ':'
                  - - 'arn'
                    - 'aws'
                    - 'dynamodb'
                    - !Ref AWS::Region
                    - !Ref AWS::AccountId
                    - !Ref DatabaseAgents

  QueueMain:
    Type: AWS::SQS::Queue
    Properties:
      RedrivePolicy:
        deadLetterTargetArn:
          !GetAtt QueueDeadLetter.Arn
        maxReceiveCount: 5
      QueueName:
        !Join
        - '-'
        - - !Ref ServiceName
          - 'QueueMain'
          - !Ref Environment
  QueueDeadLetter:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        !Join
        - '-'
        - - !Ref ServiceName
          - 'QueueDeadLetter'
          - !Ref Environment

  DynamoBugs:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: !Ref DatabaseBugs
  DynamoAccounts:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: !Ref DatabaseAccounts
  DynamoAgents:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: !Ref DatabaseAgents
  DynamoComms:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: !Ref DatabaseComms

#  Service:
#    Type: AWS::Lambda::Function
#    Properties:
#      FunctionName:
#        !Join
#        - '-'
#        - - !Ref ServiceName
#          - 'lambda'
#          - !Ref Environment
#      Role:
#        !GetAtt ServiceARN.Arn
#      Runtime: go1.x
#      Handler: !Ref ServiceName
#      Environment:
#        Variables:
#          DB_REGION: !Ref AWS::Region
#          DB_BUGS_TABLE: !Ref DatabaseBugs
#          DB_ACCOUNTS_TABLE: !Ref DatabaseAccounts
#          SQS_HOSTNAME: !Ref MainQueue
#      Code:
#        S3Bucket: !Ref BuildBucket
#        S3Key: !Ref BuildKey

#
#Outputs:
#  SourceQueueURL:
#    Description: URL of the Main Queue
#    Value:
#      Ref: MainQueue
#  SourceQueueARN:
#    Description: ARN of the Main Queue
#    Value:
#      !GetAtt MainQueue.Arn
#  DeadLetterQueueURL:
#    Description: URL of the Dead Letter Queue
#    Value:
#      Ref: DeadLetterQueue
#  DeadLetterQueueARN:
#    Description: ARN of the Dead Letter Queue
#    Value:
#      !GetAtt DeadLetterQueue.Arn
